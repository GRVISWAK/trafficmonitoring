+9# Live Mode vs Simulation Mode - Behavior Specification

## Live Mode Behavior

### What Counts as a Live Request?
ONLY these 6 endpoints when hit via Swagger UI or direct HTTP calls:
- `/login` (POST)
- `/payment` (POST)
- `/search` (GET)
- `/profile` (GET)
- `/signup` (POST)
- `/logout` (POST)

### What Does NOT Count?
- `/api/stats` - Dashboard stats endpoint
- `/api/logs` - Log retrieval endpoint
- `/api/anomalies` - Anomaly retrieval endpoint
- `/api/dashboard` - Dashboard data endpoint
- `/api/analytics/*` - Analytics endpoints
- `/simulation/*` - All simulation endpoints
- `/ws` - WebSocket endpoint
- `/docs` - Swagger documentation
- `/openapi.json` - OpenAPI schema

### Live Mode Counter Behavior
```
Initial state: live_mode_stats['total_requests'] = 0

Action: POST /login via Swagger UI
Result: live_mode_stats['total_requests'] = 1 ✓

Action: GET /api/stats
Result: live_mode_stats['total_requests'] = 1 (no change) ✓

Action: POST /payment via Swagger UI
Result: live_mode_stats['total_requests'] = 2 ✓

Action: GET /simulation/stats
Result: live_mode_stats['total_requests'] = 2 (no change) ✓
```

### Live Mode Database Entries
All live requests are logged with:
```python
APILog(
    endpoint="/login",
    method="POST",
    response_time_ms=123.45,
    status_code=200,
    is_simulation=False  # ← CRITICAL FLAG
)
```

### Live Mode Stats Endpoint
`GET /api/stats` returns:
```json
{
  "mode": "LIVE",
  "total_api_calls": 5,        // Only counts real endpoint hits
  "request_count": 5,           // Same as total_api_calls
  "windows_processed": 0,       // Anomaly detection windows
  "anomalies_detected": 0,      // Live anomalies only
  "avg_response_time": 150.23,
  "error_rate": 0.05
}
```

## Simulation Mode Behavior

### What Counts as a Simulation Request?
ONLY synthetic traffic generated by the simulation engine:
- Requests created by `run_simulation()` function
- Marked with `is_simulation=True` in database
- Generated for the specified endpoint parameter

### Simulation Mode Counter Behavior
```
Initial state: simulation_stats['total_requests'] = 0

Action: POST /simulation/start?simulated_endpoint=/payment&duration_seconds=5
Result: Simulation generates ~100 requests
        simulation_stats['total_requests'] = 100 ✓
        live_mode_stats['total_requests'] = 0 (no change) ✓

Action: POST /simulation/stop
Result: simulation_stats reset to 0 ✓
        live_mode_stats['total_requests'] = 0 (still no change) ✓
```

### Simulation Mode Database Entries
All simulation requests are logged with:
```python
APILog(
    endpoint="/payment",
    method="POST",
    response_time_ms=250.00,
    status_code=200,
    is_simulation=True  # ← CRITICAL FLAG
)
```

### Simulation Mode Stats Endpoint
`GET /simulation/stats` returns:
```json
{
  "mode": "SIMULATION",
  "active": false,
  "total_requests": 0,          // Only synthetic traffic
  "windows_processed": 0,       // Simulation detection windows
  "anomalies_detected": 0,      // Simulation anomalies only
  "simulated_endpoint": "none",
  "start_time": null
}
```

## State Isolation Rules

### Rule 1: Independent Counters
```python
# Live Mode (middleware.py)
live_mode_stats = {
    'total_requests': 0,  # Only real endpoint hits
    'windows_processed': 0,
    'anomalies_detected': 0
}

# Simulation Mode (app.py)
simulation_stats = {
    'total_requests': 0,  # Only synthetic traffic
    'windows_processed': 0,
    'anomalies_detected': 0
}

# These NEVER affect each other
```

### Rule 2: Database Filtering
```python
# Live Mode queries
db.query(APILog).filter(
    (APILog.is_simulation == False) | (APILog.is_simulation == None)
)

# Simulation Mode queries
db.query(APILog).filter(
    APILog.is_simulation == True
)

# Results NEVER overlap
```

### Rule 3: State Reset
```python
# On simulation start
reset_simulation_state()  # Clears all simulation state
simulation_active = True
simulation_stats = {
    'total_requests': 0,  # Fresh start
    'windows_processed': 0,
    'anomalies_detected': 0,
    'start_time': time.time(),
    'simulated_endpoint': endpoint
}

# On simulation stop
simulation_active = False
final_stats = simulation_stats.copy()
reset_simulation_state()  # Clean up for next run
```

## Test Scenarios

### Scenario 1: Pure Live Mode
```
1. Start backend
2. Hit /login via Swagger UI (5 times)
3. Check /api/stats

Expected:
- total_api_calls: 5
- simulation_stats['total_requests']: 0
- Database: 5 entries with is_simulation=False
```

### Scenario 2: Pure Simulation Mode
```
1. Start backend
2. POST /simulation/start?simulated_endpoint=/payment&duration_seconds=5
3. Wait 6 seconds
4. Check /simulation/stats

Expected:
- simulation_stats['total_requests']: ~100
- live_mode_stats['total_requests']: 0
- Database: ~100 entries with is_simulation=True
```

### Scenario 3: Mixed Usage
```
1. Start backend
2. Hit /login via Swagger UI (3 times)
3. POST /simulation/start?simulated_endpoint=/search&duration_seconds=5
4. Hit /payment via Swagger UI (2 times)
5. Wait 6 seconds
6. Check both /api/stats and /simulation/stats

Expected:
- live_mode_stats['total_requests']: 5 (3 + 2)
- simulation_stats['total_requests']: ~100
- Database: 5 entries with is_simulation=False, ~100 with is_simulation=True
```

### Scenario 4: Multiple Simulation Runs
```
1. Start backend
2. POST /simulation/start?simulated_endpoint=/login&duration_seconds=3
3. Wait 4 seconds
4. POST /simulation/stop
5. Check /simulation/stats (should show final stats)
6. POST /simulation/start?simulated_endpoint=/payment&duration_seconds=3
7. Check /simulation/stats immediately

Expected:
- After step 4: simulation_stats shows run 1 results
- After step 5: simulation_stats reset to 0
- After step 7: simulation_stats shows run 2 starting from 0
- live_mode_stats: 0 throughout
```

## Common Mistakes to Avoid

### ❌ Wrong: Checking /api/stats after simulation
```python
# This will NOT show simulation traffic
GET /api/stats
# Returns only live mode data
```

### ✓ Correct: Check simulation stats
```python
# This shows simulation traffic
GET /simulation/stats
# Returns only simulation mode data
```

### ❌ Wrong: Expecting /api/logs to show simulation data
```python
# This filters OUT simulation data
GET /api/logs
# Returns only is_simulation=False entries
```

### ✓ Correct: Use simulation history endpoint
```python
# This shows simulation data
GET /simulation/anomaly-history
# Returns only is_simulation=True entries
```

### ❌ Wrong: Hitting /api/stats and expecting counter to increase
```python
# Admin endpoints don't count
GET /api/stats  # Counter stays same
GET /api/logs   # Counter stays same
```

### ✓ Correct: Hit real endpoints
```python
# Business endpoints count
POST /login     # Counter +1
POST /payment   # Counter +1
GET /search     # Counter +1
```

## Debugging Tips

### Check Live Mode Counter
```python
# In middleware.py, look for this log:
print(f"[LIVE] Request #{live_mode_stats['total_requests']}: {method} {endpoint}")

# This only prints for LIVE_ENDPOINTS
```

### Check Simulation Counter
```python
# In app.py run_simulation(), look for:
print(f"[SIM] Request #{total_requests} - {simulated_endpoint}")

# This only prints during active simulation
```

### Verify Database Isolation
```sql
-- Count live entries
SELECT COUNT(*) FROM api_logs WHERE is_simulation = 0 OR is_simulation IS NULL;

-- Count simulation entries
SELECT COUNT(*) FROM api_logs WHERE is_simulation = 1;

-- These should match your counters
```

## Summary

| Aspect | Live Mode | Simulation Mode |
|--------|-----------|-----------------|
| **Trigger** | Swagger UI / Direct HTTP | `/simulation/start` endpoint |
| **Endpoints** | 6 business endpoints only | Any endpoint (synthetic) |
| **Counter** | `live_mode_stats['total_requests']` | `simulation_stats['total_requests']` |
| **Database Flag** | `is_simulation=False` | `is_simulation=True` |
| **Stats Endpoint** | `/api/stats` | `/simulation/stats` |
| **Logs Endpoint** | `/api/logs` | `/simulation/anomaly-history` |
| **State Reset** | Never (cumulative) | On start/stop |
| **Isolation** | ✓ Complete | ✓ Complete |
