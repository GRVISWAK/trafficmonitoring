# Live Mode and Simulation Mode Isolation - Fixed

## Summary of Changes

### 1. Live Mode Request Counting (middleware.py)
**Problem**: Live mode counter was incrementing for ALL requests including admin/API endpoints.

**Fix**: 
- Defined `LIVE_ENDPOINTS` constant with only real business endpoints: `/login`, `/payment`, `/search`, `/profile`, `/signup`, `/logout`
- Middleware now ONLY logs and counts requests to these endpoints
- Admin endpoints (`/api/*`, `/simulation/*`) are completely ignored

**Result**: Live request count increases ONLY when real endpoints are hit via Swagger UI.

### 2. Simulation State Management (app.py)
**Problem**: Simulation state wasn't properly reset between runs, causing state leakage.

**Fix**:
- Created `reset_simulation_state()` function to reset all simulation variables
- Called on simulation start to ensure clean state
- Called on simulation stop to clean up after completion
- Removed redundant state tracking variables

**Result**: Each simulation run starts with fresh state, no carryover from previous runs.

### 3. Database Query Isolation (app.py)
**Problem**: Queries could potentially mix live and simulation data.

**Fix**:
- All live mode endpoints filter with `(is_simulation == False) | (is_simulation == None)`
- All simulation endpoints filter with `is_simulation == True`
- Separate endpoints for live logs (`/api/logs`) and simulation history (`/simulation/anomaly-history`)

**Result**: Live Mode dashboard shows ONLY real traffic, Simulation Mode shows ONLY synthetic traffic.

## Key Principles

### Live Mode
- **Counts**: Only real endpoint hits (`/login`, `/payment`, `/search`, `/profile`, `/signup`, `/logout`)
- **Ignores**: Admin endpoints, API endpoints, simulation endpoints
- **Database**: All logs marked with `is_simulation=False`
- **Stats**: Tracked in `live_mode_stats` dictionary in middleware.py

### Simulation Mode
- **Counts**: Only synthetic traffic generated by simulation engine
- **Database**: All logs marked with `is_simulation=True`
- **Stats**: Tracked in `simulation_stats` dictionary in app.py
- **Isolation**: Completely independent from Live Mode

## Testing

Run the verification script:
```bash
python verify_isolation.py
```

This tests:
1. Live Mode only counts real endpoint hits
2. Simulation traffic doesn't affect Live Mode counters
3. Simulation state resets properly between runs
4. Database queries properly filter by mode

## Expected Behavior

### Scenario 1: Hit /login via Swagger UI
- Live Mode counter: +1
- Simulation Mode counter: No change
- Database: New entry with `is_simulation=False`

### Scenario 2: Hit /api/stats endpoint
- Live Mode counter: No change (not a business endpoint)
- Simulation Mode counter: No change
- Database: No entry created

### Scenario 3: Start simulation for /payment
- Live Mode counter: No change
- Simulation Mode counter: Increases with synthetic requests
- Database: New entries with `is_simulation=True`

### Scenario 4: Stop and restart simulation
- Previous simulation stats: Cleared
- New simulation: Starts from 0
- Live Mode: Unaffected throughout

## Code Changes Summary

### middleware.py
```python
# Define live endpoints
LIVE_ENDPOINTS = {'/login', '/payment', '/search', '/profile', '/signup', '/logout'}

# Only log and count live endpoints
is_live_request = endpoint in LIVE_ENDPOINTS
if is_live_request:
    # Log to database and increment counter
```

### app.py
```python
# Reset function for clean state
def reset_simulation_state():
    global simulation_active, simulation_stats, simulation_anomaly_recorded
    simulation_active = False
    simulation_stats = {...}  # Reset to defaults
    simulation_anomaly_recorded.clear()

# Call on start
@app.post("/simulation/start")
async def start_simulation(...):
    reset_simulation_state()  # Clean slate
    simulation_active = True
    # ... start simulation

# Call on stop
@app.post("/simulation/stop")
async def stop_simulation():
    simulation_active = False
    final_stats = simulation_stats.copy()
    reset_simulation_state()  # Clean up
    return {"stats": final_stats}
```

## Verification Checklist

- [ ] Live Mode counter increases only for `/login`, `/payment`, `/search`, `/profile`, `/signup`, `/logout`
- [ ] Admin endpoints (`/api/stats`, `/api/logs`) don't increment Live Mode counter
- [ ] Simulation traffic doesn't affect Live Mode counter
- [ ] Simulation state resets to 0 between runs
- [ ] `/api/logs` returns only live traffic (is_simulation=False)
- [ ] `/simulation/anomaly-history` returns only simulation data (is_simulation=True)
- [ ] Live Mode dashboard shows only real traffic metrics
- [ ] Simulation Mode dashboard shows only synthetic traffic metrics

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     FastAPI Application                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │    LIVE MODE         │      │   SIMULATION MODE    │    │
│  │                      │      │                      │    │
│  │  Endpoints:          │      │  Endpoints:          │    │
│  │  - /login            │      │  - /simulation/start │    │
│  │  - /payment          │      │  - /simulation/stop  │    │
│  │  - /search           │      │  - /simulation/stats │    │
│  │  - /profile          │      │                      │    │
│  │  - /signup           │      │  State:              │    │
│  │  - /logout           │      │  - simulation_stats  │    │
│  │                      │      │  - simulation_active │    │
│  │  State:              │      │                      │    │
│  │  - live_mode_stats   │      │  Database:           │    │
│  │                      │      │  - is_simulation=True│    │
│  │  Database:           │      │                      │    │
│  │  - is_simulation=False│     │                      │    │
│  └──────────────────────┘      └──────────────────────┘    │
│           │                              │                   │
│           │                              │                   │
│           ▼                              ▼                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              SQLite Database                         │   │
│  │  ┌──────────────────┐  ┌──────────────────────┐    │   │
│  │  │  api_logs        │  │  anomaly_logs        │    │   │
│  │  │  - is_simulation │  │  - is_simulation     │    │   │
│  │  └──────────────────┘  └──────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Notes

- Live Mode and Simulation Mode are **completely independent**
- No shared state between modes
- Database uses `is_simulation` flag for filtering
- Middleware only tracks live endpoint hits
- Simulation engine generates synthetic traffic with `is_simulation=True`
- Each mode has its own stats dictionary
- Simulation state resets on start/stop for clean runs
